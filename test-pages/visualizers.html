<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<title>KITT Visualizer Test</title>

		<style>
			#visualKitt {
				width:fit-content;
				margin:30px 20px 20px 20px;
				border:1px solid black;
				padding:0 0 0 50px;
			}
			#visualKitt > div {
				display:inline-block;
				width:100px;
				height:430px;
				margin-left:-50px;
			}
			#visualKitt > div > div {
				width:40px;
				height:20px;
				background-color:darkred;
				margin:8px auto;
				border-radius:2.5px;
			}
		</style>
	</head>
	<body>
		<div id="visualKitt">
			<div id="kittL">
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
			</div>
			<div id="kittM">
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
			</div>
			<div id="kittR">
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
			</div>
			<button class="runVisualizer">Run Kitt</button>
		</div>

		<!-- jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

		<script>
			var kitt = {
				analyser:null,
				audio:null,
				audioSrc:null,
				barsL:[],
				barsM:[],
				barsR:[],
				ctx:null,
				frequencyData:null,
				updateTick:null,
				renderFrame:function(){
					// Updates by frames
					kitt.updateTick = requestAnimationFrame(kitt.renderFrame);

					kitt.analyser.getByteFrequencyData(kitt.frequencyData);

					// The for loop should only go up to just under half.
					var barMax = kitt.barsM.length;
					var forMax = Math.floor(barMax / 2);

					var freq = 50;
					var percentile = 0.60;

					$(kitt.barsL[forMax]).css("background-color","rgb("+(100 + (kitt.frequencyData[freq] * percentile))+",0,0)");
					$(kitt.barsM[forMax]).css("background-color","rgb("+(100 + (kitt.frequencyData[freq]))+",0,0)");
					$(kitt.barsR[forMax]).css("background-color","rgb("+(100 + (kitt.frequencyData[freq] * percentile))+",0,0)");

					for(var i = 1; i < forMax; i++){
						$(kitt.barsL[forMax - i]).css("background-color","rgb("+(100 + (kitt.frequencyData[freq] * ((forMax - i) / forMax) * percentile))+",0,0)");
						$(kitt.barsL[forMax + i]).css("background-color","rgb("+(100 + (kitt.frequencyData[freq] * ((forMax - i) / forMax) * percentile))+",0,0)");

						$(kitt.barsM[forMax - i]).css("background-color","rgb("+(100 + (kitt.frequencyData[freq] * ((forMax - i) / forMax)))+",0,0)");
						$(kitt.barsM[forMax + i]).css("background-color","rgb("+(100 + (kitt.frequencyData[freq] * ((forMax - i) / forMax)))+",0,0)");

						$(kitt.barsR[forMax - i]).css("background-color","rgb("+(100 + (kitt.frequencyData[freq] * ((forMax - i) / forMax) * percentile))+",0,0)");
						$(kitt.barsR[forMax + i]).css("background-color","rgb("+(100 + (kitt.frequencyData[freq] * ((forMax - i) / forMax) * percentile))+",0,0)");
					}
				}
			}

			function createVisualizer(calledFrom){
				if($(calledFrom).attr("id") == "visualKitt"){
					kitt.barsL = $("#kittL").children();
					kitt.barsM = $("#kittM").children();
					kitt.barsR = $("#kittR").children();

					for(var i = 0; i < kitt.barsM.length; i++){
						$(kitt.barsL[i]).css("background-color","rgb(100,0,0)");
						$(kitt.barsM[i]).css("background-color","rgb(100,0,0)");
						$(kitt.barsR[i]).css("background-color","rgb(100,0,0)");
					}

					kitt.audio = new Audio("https://dl.dropboxusercontent.com/s/9pamibo40ycabe1/_EnV_%20-%20Heaven.mp3");
					kitt.audio.crossOrigin = "anonymous";
					kitt.ctx = new AudioContext();
					kitt.audioSrc = kitt.ctx.createMediaElementSource(kitt.audio);
					kitt.analyser = kitt.ctx.createAnalyser();

					kitt.audioSrc.connect(kitt.analyser);

					kitt.frequencyData = new Uint8Array(kitt.analyser.frequencyBinCount);

					kitt.audio.play();
					kitt.updateTick = requestAnimationFrame(kitt.renderFrame);
				}
			}

			function init(){
				$(".runVisualizer").click(function(){
					createVisualizer($(this).parent());
				});
			}

			init();
		</script>
	</body>
</html>
